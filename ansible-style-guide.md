**Style Guide для Ansible**

> Версия документа: `1.0`<br/>
> Дата документа: `2021-12-30`

---

[TOC]

## Форматирование (Formatting)

#### f1. Формат файла

* Кодировка: `UTF-8 without BOM`
* Символ конца строки: `LF` (Unix style)

#### f2. Конец файла

Файл всегда завершается символом перевода строки (`LF`).

#### f3. Отступы

В качестве отступа в YAML-файле используется **2** пробела. Это касается и списков.

* плохо:
  ```yaml
  - hosts: all
    roles:
    - { role: manage_repository, thirdparty_repos_enable: true }
    - { role: server_defaults }
    tags:
    - initial
    - never
  ```

* хорошо:
  ```yaml
  - hosts: all
    roles:
      - { role: manage_repository, thirdparty_repos_enable: true }
      - { role: server_defaults }
    tags:
      - initial
      - never
  ```

#### f4. Разделитель — пустая строка

Пустая строка ставится между plays, tasks, inventory-группами.

#### f5. Блочные тэги Jinja2

Чтобы корректно вписать в YAML-файл блочные тэги Jinja2 (например, `{% if %}`, `{% for %}`), не поломав
отступы и не добавляя лишние пустые строки, необходимо соответствующим образом настроить Jinja2-параметры
[`lstrip_blocks`](https://jinja.palletsprojects.com/en/3.0.x/api/?highlight=lstrip_blocks#jinja2.Environment) и
[`trim_blocks`](https://jinja.palletsprojects.com/en/3.0.x/api/?highlight=trim_blocks#jinja2.Environment)
через директиву `#jinja2` в первой строке шаблона
(см. [Notes](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html#notes)
к модулю **template**):

  ```
  #jinja2: lstrip_blocks: True, trim_blocks: True
  ```

Пример:

* `docker-compose.yml.j2`:
  ```yaml
  #jinja2: lstrip_blocks: True, trim_blocks: True
  services:
    service:
      image: java-app:latest
      restart: always
      environment:
        ADMIN_MAIL_SUPPORT: hd-{{ STAND }}@it2g.ru
      {% if STAND != "prod" %}
        JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
      {% endif %}
        SPRING_PROFILES_ACTIVE: std-{{ STAND }}
      ports:
        - "5005:5005"
  ```
  _Обратите внимание: блочные Jinja2-тэги располагаются со сдвигом влево относительного самого
  содержимого блока. Это позволяет визуально выделить эти тэги из общего контекста и одновременно
  сохранить реальный сдвиг содержимого блока._


* `docker-compose.yml` при `STAND == 'test'`:
  ```yaml
  services:
    service:
      image: java-app:latest
      restart: always
      environment:
        ADMIN_MAIL_SUPPORT: hd-test@it2g.ru
        JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
        SPRING_PROFILES_ACTIVE: std-test
      ports:
        - "5005:5005"
  ```

* `docker-compose.yml` при `STAND == 'prod'`:
  ```yaml
  services:
    service:
      image: java-app:latest
      restart: always
      environment:
        ADMIN_MAIL_SUPPORT: hd-prod@it2g.ru
        SPRING_PROFILES_ACTIVE: std-prod
      ports:
        - "5005:5005"
  ```

#### f6. Заголовок файла, содержимое которого управляется через Ansible

Если содержимое файла контролируется Ansible'ом, то по возможности добавлять в него заголовок,
сигнализирующий об этом.

Например:
```
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# #  Managed by Ansible                                                     # #
# #  DO NOT EDIT THIS FILE MANUALLY                                         # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```

Как правило, это касается шаблонов и текстовых файлов, целиком копируемых на хост.

## Синтаксис (Syntax)

#### s1. Boolean-значения задаются только через `true` или `false`

* плохо:
  ```yaml
  - name: Start service Nginx
    service:
      name: nginx
      enabled: 1
    become: yes
  ```

* хорошо:
  ```yaml
  - name: Start service Nginx
    service:
      name: nginx
      enabled: true
    become: true
  ```

#### s2. Директивы определяются только через map-синтаксис

* плохо:
  ```yaml
  - name: Copy file defaults.conf
    file: 'dest=/etc/ src=defaults.conf'
  ```

* хорошо:
  ```yaml
  - name: Copy file defaults.conf
    file:
      dest: /etc/
      src: defaults.conf
  ```

#### s3. Значения директивы `tags` всегда задаются в виде списка

Такой синтаксис позволяет легко добавлять и удалять тэги.

* плохо:
  ```yaml
  tags: common
  ```

* хорошо:
  ```yaml
  tags:
    - common
  ```

## Именование (Naming)

#### n1. Стиль именования __snake_case__ для переменных, ролей, inventory-групп и файлов

Стиль **[snake_case](https://ru.wikipedia.org/wiki/Snake_case)** используется для имён модулей
Ansible. Поэтому есть смысл распространить это соглашение на имена переменных, ролей и файлов.

Для inventory-групп это требование Ansible, начиная с версии 2.10.

* inventory:
  ```yaml
    children:

      app_servers:
        hosts:
          dodms-app-aio-1:
          dodms-app-aio-2:

      front_servers:
        hosts:
          dodms-oib-aio-1:
  ```

#### n2. Имена переменных в inventory всегда ЗАГЛАВНЫМИ буквами

Разумеется, это не касается служебных Ansible-переменных.

* inventory:
  ```yaml
  ---
  all:

    vars:
      ansible_user: 'root'

      LOKI_PORT: 3100
      LOKI_SERVER: "{{ hostvars[groups['loki_server'][0]].ansible_host }}"
      LOKI_URL: http://{{ LOKI_SERVER }}:{{ LOKI_PORT }}/loki/api/v1/push
      MINIO:
        ACCESS_KEY: "minio"
        SECRET_KEY: "minio123"
      STAND: test-1
  ```

#### n3. Имена extra-переменных в плейбуке всегда ЗАГЛАВНЫМИ буквами

[Extra-переменные](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#defining-variables-at-runtime)
— это переменные плейбука, заданные через аргументы командной строки
`--extra-vars` (или `-e`).

Extra-переменные необходимо описывать в комментариях в заголовке плейбука, чтобы
отделять их от переменных из inventory, которые также именуются заглавными буквами.

* плейбук:
  ```yaml
  # Плейбук зависит от переменных, задаваемых через опцию --extra-vars:
  #
  #   CICD_IMAGES_TAG - общий тэг всех docker-образов для деплоя

  - hosts: front_servers
    gather_facts: false
    roles:
      - role: dockerized-service
        vars:
          service_name: ms-dodms-ui
          service_port: 8064
          dest: /opt/{{ service_name }}
          compose: |
            version: "3.4"
            services:
              service:
                image: it2g/dodms/{{ service_name }}:{{ CICD_IMAGES_TAG }}
                restart: always
                ports:
                  - "{{ service_port }}:80"
    tags:
      - ms-dodms-ui
  ```

#### n4. Имена переменных в плейбуке и в роли всегда строчными буквами

Это позволяет отделять _внешние переменные_ (inventory и extra) от всех остальных переменных.

#### n5. Имена приватных переменных роли всегда с префиксом `_` (знак подчёркивания)

Благодаря этому в исходном коде хорошо различаются входные переменные (параметры) роли и
внутренние (приватные) переменные роли, которые определяются и используются только внутри
роли.

Про входные и приватные переменные роли см. [Дизайн](#дизайн).

```yaml
TODO: пример
```

#### n6. Именование registering-переменных

[Registering-переменные](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#registering-variables)
— это переменные, сохраняющие результат выполнения task через директиву `register`.

* Префикс `r__` (два знака подчёркивания), если переменная используется в последующих tasks:
  ```yaml
  - name: "Расширение {{ extension_info.name }} | Определить уже установленную версию"
    shell: gnome-extensions info "{{ extension_info.uuid }}" | sed -n '/Version:/s/[^0-9.]*\([0-9.]*\).*/\1/p'
    register: r__extension_installed_version
    changed_when: false

  - name: "Расширение {{ extension_info.name }} | Версия установленного: {{ r__extension_installed_version.stdout or 0 }}"
    set_fact:
      _extension_version:
        installed: "{{ r__extension_installed_version.stdout or 0 }}"
        website: "{{ extension_info.version }}"
  ```

* `result`, если переменная используется _только_ в пределах task:
  ```yaml
  - name: Docker pull images
    command:
      cmd: docker-compose pull
      chdir: "{{ dest }}"
    register: result
    changed_when: "'... status: downloaded newer image' in result.stderr | default('')"
  ```

## Упорядочивание (Ordering)

#### o1. Переменные определяются в алфавитном порядке

Это удобно. При этом Ansible позволяет ссылаться на переменные, определенные ниже по тексту.

```yaml
TODO: пример из defaults
```

#### o2. TODO: Группы в inventory разбиваются по категориям и внутри категорий сортируются по алфавиту

```yaml
TODO: пример
```

#### o3. Порядок определения директив в play

1. `hosts`
1. [play-директивы](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#play) в алфавитном порядке
1. `pre_tasks`
1. `roles`
1. `tasks`
1. `tags`

Всегда начинаем с `hosts` и при необходимости заканчиваем с `tags`. Между ними определяем необходимые
директивы в алфавитном порядке, кроме директив `pre_tasks`, `roles` и `tasks`, порядок которых отражает
порядок выполнения самого play.

```yaml
TODO: пример
```

#### o4. Порядок определения директив в role

1. `role`
1. `vars` с переменными роли в **смысловом** / произвольном порядке
1. [role-директивы](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#role) в алфавитном порядке
1. `tags`

Сначала определяем роль и её переменные в порядке, удобном для восприятия. Далее определяем 
в алфавитном порядке все остальные директивы role. При необходимости завершаем директивой `tags`.

```yaml
TODO: пример
```

Допустимо использовать короткую версию записи role:

```yaml
- { role: server_defaults }
- { role: manage_repository, thirdparty_repos_enable: true }
- { role: manage_docker, insecure_registries: ["172.17.21.6:4444"], registry_mirrors: ["http://172.17.21.6:4444"] }
```

#### o5. Порядок определения директив в task

1. [`name`] (необязательно для модулей `import*` и `include*`)
1. модуль с параметрами в **смысловом** / произвольном порядке
1. цикл (`loop`, `loop_control`, `with_items`)
1. [task-директивы](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#task) в алфавитном порядке
1. `tags`

TODO: надо ли цикл выделять в отдельную категорию? Или как обычную директиву в алфавитном порядке?

Всегда начинаем с `name` и при необходимости заканчиваем с `tags`. Сразу после `name` описываем
модуль с его параметрами в произвольном порядке. Далее определяем цикл, если он используется.
Затем определяем в алфавитном порядке все остальные директивы task.

```yaml
TODO: пример
```

## Дизайн (Design)

#### d1. Один плейбук — много стендов

Другими словами, плейбук не должен быть специфичным для какого-либо стенда.

Если какой-либо play не должен выполняться на определенном стенде, то в inventory стенда
соответствующая группа объявляется пустой (`activemq_server` в примере):

* play:
  ```yaml
  - hosts: activemq_server:
    roles:
      - activemq
  ```

* inventory:
  ```yaml
  children:

    activemq_server:
      hosts:

    minio_servers:
      hosts:
        dodms-app-aio-1:
        dodms-app-aio-2:
  ```

#### d2. Inventory. Предпочтительная структура (TODO)

#### d3. Inventory. Определение inventory-зависимых переменных (TODO)

#### d4. Роли. Роль настраивается только через свои переменные

Роль ничего не должна знать об **inventory** или
[**extra**-переменных](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#defining-variables-at-runtime).
Если в роли необходимо реализовать inventory-зависимый функционал или использовать extra-переменные,
то все необходимые значения должны передаваться через [входные переменные](#d5-роли-входные-переменные) роли.

* play:
  ```yaml
  # Плейбук зависит от переменных, задаваемых через опцию --extra-vars:
  #
  #   CICD_IMAGES_TAG - общий тэг всех docker-образов для деплоя

  ---
  - hosts: app-servers
    gather_facts: false
    roles:
      - role: lms
        vars:
          deploy_images_tag: "{{ CICD_IMAGES_TAG }}"
          deploy_stand: "{{ STAND }}"
          xapi_service: "{{ hostvars[groups['xapi_server'][0]].ansible_host }}:8081"
    tags:
      - lms
  ```

* inventory:
  ```yaml
  all:

    vars:
      STAND: test-1

    hosts:
      app-srv-sdo-1:
        ansible_host: 172.17.40.65

    children:

      xapi_server:
        hosts:
          app-srv-sdo-1:
  ```

#### d5. Роли. Входные переменные

Входные переменные роли — это переменные, переданные в роль через директиву `vars`.
Служат для задания входных параметров роли.

```yaml
TODO: пример
```

Входные переменные роли могут быть двух типов:
* **обязательные** — роль не может выполняться без задания значений этих переменных при вызове роли
* **необязательные** — роль выполняется со значениями по-умолчанию, если эти переменные не заданы при вызове роли

Все входные переменные описываются в файле `defaults/main.yml`:
1. Сначала **обязательные** в алфавитном порядке в виде простого списка `_required_vars`
   (_пустого списка_, если обязательные переменные у роли отсутствуют)
1. Далее **необязательные** в алфавитном порядке со значениями по-умолчанию

Примеры:

* `defaults/main.yml` (у роли с тремя обязательными и двумя необязательными переменными):
  ```yaml
  ---
  _required_vars:
    - compose
    - service_name
    - service_port
 
  down_before_up: false
  files: []
  ```

* `defaults/main.yml` (у роли без входных переменных):
  ```yaml
  ---
  _required_vars: []
  ```

Таким образом, глядя в `defaults/main.yml`, всегда видно **все** входные переменные роли
(или их отсутствие, если роль не принимает никаких параметров).

Выполнение роли всегда должно начинаться с проверки наличия всех обязательных переменных роли:

* `tasks/main.yml`:
  ```yaml
  ---
  - name: Verify that required variables are defined
    fail:
      msg: "Variable '{{ item }}' is not defined"
    when: item not in vars
    with_items: '{{ _required_vars }}'
  ```

#### d6. Роли. Приватные переменные

Приватные переменные роли — это переменные, которые определяются и используются исключительно
внутри роли. Значения этих переменных зависят только от внутренней логики самой роли.

Приватные переменные определяются в каталоге `vars`.

* `vars/main.yml`:
  ```yaml
  ---
  TODO: пример из intranet-docker, про ключи
  ```

#### d7. Роли. Область видимости переменных

Все переменные, определённые в роли, должны оставаться доступными только внутри роли.

Чтобы обеспечить это, необходимо добавить параметр `private_role_vars` в конфигурацию Ansible:

* `ansible.cfg`:
  ```ini
  [defaults]
  private_role_vars = true
  ```

Пример того, какой эффект оказывает этот параметр при использовании ролей:

* `roles/test/defaults/main.yml`:
  ```yaml
  ---
  _required_vars:
    - service_name

  service_port: 8000
  ```

* `roles/test/tasks/main.yml`:
  ```yaml
  ---
  - name: Install '{{ service_name }}'
    debug:
      var: service_port
  ```

* плейбук:
  ```yaml
  - hosts: 127.0.0.1
    connection: local
    gather_facts: false
    roles:
      - role: test
        vars:
          service_name: service_one
          service_port: 9999

      - role: test
        vars:
          service_name: service_two
          # ожидается, что service_port при выполнении этой роли примет значнение по-умолчанию (8000)
  ```

* Выполнение плейбука при `private_role_vars = false` (значение по-умолчанию):
  ```
  PLAY [127.0.0.1] *********************************************************************************

  TASK [test : Install 'service_one'] **************************************************************
  ok: [127.0.0.1] => {
      "service_port": 9999
  }

  TASK [test : Install 'service_two'] **************************************************************
  ok: [127.0.0.1] => {
      "service_port": 9999
  }
  ```

* Выполнение плейбука при `private_role_vars = true` (как должно быть):
  ```
  PLAY [127.0.0.1] *********************************************************************************

  TASK [test : Install 'service_one'] **************************************************************
  ok: [127.0.0.1] => {
      "service_port": 9999
  }

  TASK [test : Install 'service_two'] **************************************************************
  ok: [127.0.0.1] => {
      "service_port": 8000
  }
  ```

## Приложение. Инструментарий (TODO)

* `ansible.cfg`
* `editorconfig`
* `.gitattributes`
* `yamlint`
* `ansiblelint`
