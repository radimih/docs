**Style Guide для Ansible**

> Версия документа: `1.0`<br/>
> Дата документа: `2022-01-XX`

---

[TOC]

## Форматирование (Formatting)

#### f1. Формат файла

* Кодировка: `UTF-8 without BOM`
* Символ конца строки: `LF` (Unix style)

#### f2. Конец файла

Файл всегда завершается символом перевода строки (`LF`).

#### f3. Отступы

В качестве отступа в YAML-файле используется **2** пробела. Это касается и списков.

* плохо:
  ```yaml
  - hosts: all
    roles:
    - { role: manage_repository, thirdparty_repos_enable: true }
    - { role: server_defaults }
    tags:
    - initial
    - never
  ```

* хорошо:
  ```yaml
  - hosts: all
    roles:
      - { role: manage_repository, thirdparty_repos_enable: true }
      - { role: server_defaults }
    tags:
      - initial
      - never
  ```

#### f4. Разделитель — пустая строка

Пустая строка ставится между plays, tasks, inventory-группами.

#### f5. Блочные тэги Jinja2

Чтобы корректно вписать в YAML-файл блочные тэги Jinja2 (например, `{% if %}`, `{% for %}`), не поломав
отступы и не добавляя лишние пустые строки, необходимо соответствующим образом настроить Jinja2-параметры
[`lstrip_blocks`](https://jinja.palletsprojects.com/en/3.0.x/api/?highlight=lstrip_blocks#jinja2.Environment) и
[`trim_blocks`](https://jinja.palletsprojects.com/en/3.0.x/api/?highlight=trim_blocks#jinja2.Environment)
через директиву `#jinja2` в первой строке шаблона
(см. [Notes](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html#notes)
к модулю **template**):

  ```
  #jinja2: lstrip_blocks: True, trim_blocks: True
  ```

Пример:

* `docker-compose.yml.j2`:
  ```yaml
  #jinja2: lstrip_blocks: True, trim_blocks: True
  services:
    service:
      image: java-app:latest
      restart: always
      environment:
        ADMIN_MAIL_SUPPORT: hd-{{ STAND }}@it2g.ru
      {% if STAND != "prod" %}
        JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
      {% endif %}
        SPRING_PROFILES_ACTIVE: std-{{ STAND }}
      ports:
        - "5005:5005"
  ```
  _Обратите внимание: блочные Jinja2-тэги располагаются со сдвигом влево относительного самого
  содержимого блока. Это позволяет визуально выделить эти тэги из общего контекста и одновременно
  сохранить реальный сдвиг содержимого блока._


* `docker-compose.yml` при `STAND == 'test'`:
  ```yaml
  services:
    service:
      image: java-app:latest
      restart: always
      environment:
        ADMIN_MAIL_SUPPORT: hd-test@it2g.ru
        JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
        SPRING_PROFILES_ACTIVE: std-test
      ports:
        - "5005:5005"
  ```

* `docker-compose.yml` при `STAND == 'prod'`:
  ```yaml
  services:
    service:
      image: java-app:latest
      restart: always
      environment:
        ADMIN_MAIL_SUPPORT: hd-prod@it2g.ru
        SPRING_PROFILES_ACTIVE: std-prod
      ports:
        - "5005:5005"
  ```

#### f6. Заголовок файла, содержимое которого управляется через Ansible

Если содержимое файла контролируется Ansible'ом, то по возможности добавлять в него заголовок,
сигнализирующий об этом.

Например:
```
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# #  Managed by Ansible                                                     # #
# #  DO NOT EDIT THIS FILE MANUALLY                                         # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```

Как правило, это касается шаблонов и текстовых файлов, целиком копируемых на хост.

## Синтаксис (Syntax)

#### s1. Boolean-значения задаются только через `true` или `false`

* плохо:
  ```yaml
  - name: Start service Nginx
    service:
      name: nginx
      enabled: 1
    become: yes
  ```

* хорошо:
  ```yaml
  - name: Start service Nginx
    service:
      name: nginx
      enabled: true
    become: true
  ```

#### s2. Директивы определяются только через map-синтаксис

* плохо:
  ```yaml
  - name: Copy file defaults.conf
    file: 'dest=/etc/ src=defaults.conf'
  ```

* хорошо:
  ```yaml
  - name: Copy file defaults.conf
    file:
      dest: /etc/
      src: defaults.conf
  ```

#### s3. Значения директивы `tags` всегда задаются в виде списка

Такой синтаксис позволяет легко добавлять и удалять тэги.

* плохо:
  ```yaml
  tags: common
  ```

* хорошо:
  ```yaml
  tags:
    - common
  ```

## Именование (Naming)

#### n1. Стиль именования _snake_case_ для переменных, ролей, inventory-групп и файлов

Так как все стандартные модули Ansible именуются в стиле [**snake_case**](https://ru.wikipedia.org/wiki/Snake_case),
есть смысл распространить это соглашение на имена переменных, ролей и файлов.

Для inventory-групп это требование Ansible, начиная с версии 2.10.

* inventory:
  ```yaml
    children:

      app_servers:
        hosts:
          dodms-app-aio-1:
          dodms-app-aio-2:

      front_servers:
        hosts:
          dodms-oib-aio-1:
  ```

#### n2. Имена переменных в inventory всегда ЗАГЛАВНЫМИ буквами

Разумеется, это не касается служебных Ansible-переменных.

* inventory:
  ```yaml
  ---
  all:

    vars:
      ansible_user: 'root'

      LOKI_PORT: 3100
      LOKI_SERVER: "{{ hostvars[groups['loki_server'][0]].ansible_host }}"
      LOKI_URL: http://{{ LOKI_SERVER }}:{{ LOKI_PORT }}/loki/api/v1/push
      MINIO:
        ACCESS_KEY: "minio"
        SECRET_KEY: "minio123"
      STAND: test-1
  ```

#### n3. Имена extra-переменных в плейбуке всегда ЗАГЛАВНЫМИ буквами

Extra-переменные (см. [Defining variables at runtime](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#defining-variables-at-runtime))
— это переменные плейбука, заданные через аргументы командной строки `--extra-vars` (или `-e`).

Extra-переменные необходимо описывать в комментариях в заголовке плейбука, чтобы
отделять их от переменных из inventory, которые также именуются заглавными буквами.

* плейбук:
  ```yaml
  # Плейбук зависит от переменных, задаваемых через опцию --extra-vars:
  #
  #   CICD_IMAGES_TAG - общий тэг всех docker-образов для деплоя

  - hosts: front_servers
    gather_facts: false
    roles:
      - role: dockerized-service
        vars:
          service_name: ms-dodms-ui
          service_port: 8064
          dest: /opt/{{ service_name }}
          compose: |
            version: "3.4"
            services:
              service:
                image: it2g/dodms/{{ service_name }}:{{ CICD_IMAGES_TAG }}
                restart: always
                ports:
                  - "{{ service_port }}:80"
    tags:
      - ms-dodms-ui
  ```

#### n4. Имена переменных в плейбуке и в роли всегда строчными буквами

Это позволяет отделять _внешние переменные_ (inventory и extra) от всех остальных переменных.

#### n5. Имена приватных переменных роли всегда с префиксом `_` (знак подчёркивания)

Благодаря этому в исходном коде роли хорошо различаются аргументы (параметры) роли и
внутренние (приватные) переменные роли, которые определяются и используются только внутри
роли.

Про аргументы и приватные переменные роли см. [Дизайн](#дизайн).

```yaml
TODO: пример
```

#### n6. Именование registering-переменных

Registering-переменные (см. [Registering variables](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#registering-variables))
— это переменные, сохраняющие результат выполнения task через директиву `register`.

* Префикс `r__` (два знака подчёркивания), если переменная используется в последующих tasks:
  ```yaml
  - name: "Расширение {{ extension_info.name }} | Определить уже установленную версию"
    shell: gnome-extensions info "{{ extension_info.uuid }}" | sed -n '/Version:/s/[^0-9.]*\([0-9.]*\).*/\1/p'
    register: r__extension_installed_version
    changed_when: false

  - name: "Расширение {{ extension_info.name }} | Версия установленного: {{ r__extension_installed_version.stdout or 0 }}"
    set_fact:
      _extension_version:
        installed: "{{ r__extension_installed_version.stdout or 0 }}"
        website: "{{ extension_info.version }}"
  ```

* `result`, если переменная используется _только_ в пределах task:
  ```yaml
  - name: Docker pull images
    command:
      cmd: docker-compose pull
      chdir: "{{ dest }}"
    register: result
    changed_when: "'... status: downloaded newer image' in result.stderr | default('')"
  ```

## Упорядочивание (Ordering)

#### o1. Порядок перечисления хостов в директиве `hosts`

Если требуется указать несколько хостов или групп хостов в директиве `hosts`, то они перечисляются
в **алфавитном** порядке.

* play:
  ```yaml
  - hosts:
      - activemq_server
      - signing_server
      - work_calendar_server
    roles:
      ...
  ```

#### o2. Порядок перечисления тэгов в директиве `tags`

Тэги в директиве `tags` перечисляются в **алфавитном** порядке.

* play:
  ```yaml
  TODO: пример
  ```

#### o3. Порядок перечисления хостов и групп хостов в inventory

Хосты в директиве `hosts` перечисляются в **алфавитном** порядке.

* inventory:
  ```yaml
  ---
  all:

    hosts:
      dev-db:
        ansible_host: 10.234.93.11
      dev-files:
        ansible_host: 10.234.93.12

    children:

      backoffice:
        hosts:
          dev-db:
          dev-files:
  ```

Группы и подгруппы внутри групп определяются в inventory в **алфавитном** порядке.

* inventory:
  ```yaml
  ---
  all:

    hosts:
      dev-db:
        ansible_host: 10.234.93.11
      dev-files:
        ansible_host: 10.234.93.12

    children:

      docker_registry:
        children:
          file_storage:

      nfs_server:
        hosts:

      services:
        children:

          db:
            hosts:
              dev-db:

          file_storage:
            hosts:
              dev-files:
  ```
  _Обратите внимание: группа_ `docker_registry` _ссылается на подгруппу_ `file_storage`_, которая определятся ниже._

#### o4. Порядок определения переменных

Переменные определяются в **алфавитном** порядке:
  * в **inventory**
  * у **роли** в `defaults/main.yml` и `vars/main.yml`
  * в секциях **play** и **task** через директиву `vars`

Примечания:
  * Это правило не касается [аргументов роли](#d5-роли-аргументы) в секции **role**, которые
    перечисляются в смысловом/произвольном порядке.
  * Ansible позволяет в значениях переменных ссылаться на переменные, перечисленные ниже в этом же блоке определений.

Примеры:

* inventory:
  ```yaml
  TODO: пример
  ```

* `vars/main.yml`:
  ```yaml
  TODO: пример
  ```

* плейбук:
  ```yaml
  TODO: пример
  ```

#### o5. Порядок определения директив

В зависимости от типа секции, директивы (см. [Playbook Keywords](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html))
перечисляются в следующем порядке:

<table>
<thead>
<th>

Play

</th>
<th>

Role

</th>
<th>

Task

</th>
<tr>
</thead>
<tbody>
<td valign="top">

1. `hosts`
1. остальные [play-директивы](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#play)<br>
   в **произвольном** порядке
1. `pre_tasks`
1. `roles` / `tasks`
1. `post_tasks`
1. `handlers`
1. `tags`

```yaml
TODO: пример
```

</td>
<td valign="top">

1. `role`
1. `vars`
   * аргументы роли<br> в **произвольном** порядке
1. остальные [role-директивы](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#role)<br>
   в **произвольном** порядке
1. `tags`


```yaml
TODO: пример



```

</td>
<td valign="top">

1. `name`
1. модуль
   * параметры модуля<br> в **произвольном** порядке
1. остальные [task-директивы](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#task)<br>
   в **произвольном** порядке
1. `tags`

```yaml
TODO: пример



```

</td>
</tr>
<tr>
<td colspan="3">

1. Секция начинается с _ключевой директивы_: `hosts`, `role` или `name` (директива `name` необязательна для модулей `import_*` и `include_*`).
1. Далее для секций **role** и **task** указывается _роль_ с аргументами или _модуль_ с соответствующими параметрами.
1. Далее следуют _остальные директивы_ секции в произвольном порядке.
1. Далее для секции **play** следуют директивы в порядке их выполнения: `pre_tasks`, `roles`, `tasks`, `post_tasks`, `handlers`
1. Последней директивой в секции указывается `tags`, если необходимо задать тэги секции.

Рекомендации:

* Одновременное использование директив `roles` и `tasks` нежелательно из-за неочевидного порядка выполнения
  (сначала выполняется `roles`, затем `tasks`).  Совместно с `roles` лучше использовать директивы `pre_tasks`
  и `post_tasks`, если необходимо выполнить какие-либо задачи _до_ и _после_ выполнения ролей.
* Одновременное использование директив `pre_tasks`, `tasks` и `post_tasks` почти всегда лишено смысла.
  Лучше использовать одну директиву `tasks`. Единственное исключение — выполнение handler'ов. Они
  выполняются отдельно в конце каждой директивы `pre_tasks`, `tasks` и `post_tasks`.

</td>
</tr>
</tbody>
</table>

Допустимо использовать короткую версию записи role, если эта запись не будет слишком длинной:

```yaml
- { role: server_defaults, tags: [initial] }
- { role: manage_repository, thirdparty_repos_enable: true, tags: [initial, never] }
- { role: manage_docker, insecure_registries: ["172.17.21.6:4444"], registry_mirrors: ["http://172.17.21.6:4444"] }
```

## Дизайн (Design)

#### d1. Один плейбук — много стендов

Другими словами, плейбук не должен быть специфичным для какого-либо стенда.

Если какой-либо play не должен выполняться на определенном стенде, то в inventory стенда
соответствующая группа объявляется пустой (`activemq_server` в примере):

* play:
  ```yaml
  - hosts: activemq_server:
    roles:
      - activemq
  ```

* inventory:
  ```yaml
  children:

    activemq_server:
      hosts:

    minio_servers:
      hosts:
        dodms-app-aio-1:
        dodms-app-aio-2:
  ```

#### d2. Inventory. Предпочтительная структура (TODO)

#### d3. Inventory. Определение inventory-зависимых переменных (TODO)

#### d4. Роли. Роль управляется только через свои аргументы

Роль ничего не должна знать об **inventory** или [**extra**-переменных](#n3-имена-extra-переменных-в-плейбуке-всегда-заглавными-буквами).
Если в роли необходимо реализовать inventory-зависимый функционал или использовать extra-переменные,
то все необходимые значения должны передаваться через [аргументы роли](#d5-роли-аргументы).

* play:
  ```yaml
  # Плейбук зависит от переменных, задаваемых через опцию --extra-vars:
  #
  #   CICD_IMAGES_TAG - общий тэг всех docker-образов для деплоя

  ---
  - hosts: app-servers
    gather_facts: false
    roles:
      - role: lms
        vars:
          deploy_images_tag: "{{ CICD_IMAGES_TAG }}"
          deploy_stand: "{{ STAND }}"
          xapi_service: "{{ hostvars[groups['xapi_server'][0]].ansible_host }}:8081"
    tags:
      - lms
  ```

* inventory:
  ```yaml
  all:

    vars:
      STAND: test-1

    hosts:
      app-srv-sdo-1:
        ansible_host: 172.17.40.65

    children:

      xapi_server:
        hosts:
          app-srv-sdo-1:
  ```

#### d5. Роли. Аргументы

Аргументы роли — это переменные, переданные в роль через директиву `vars`.
Служат для задания входных параметров роли.

```yaml
TODO: пример вызова роли с аргументами
```

Все аргументы роли описываются в файле `meta/main.yml`
(см. [Role argument validation](https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#role-argument-validation))
в секции `argument_specs`:

* `meta/main.yml`:
  ```yaml
  galaxy_info:
    author: Radimir Mikhailov
    description: Install apt-based third party package
    license: MIT

    min_ansible_version: 2.11

    platforms:
      - name: Debian
        versions:
          - all
      - name: Ubuntu
        versions:
          - all

    galaxy_tags: []

  dependencies: []

  argument_specs:
    main:
      options:
        key_url:
          description: Public key URL of the repository
          required: true
          type: str
        repo_url:
          description: Repository URL
          required: true
          type: str
        repo_component:
          description: Repository component
          required: true
          type: str
          choices:
            - contrib
            - main
            - non-free
        package_name:
          description: Package name
          required: true
          type: str
  ```

Аргументы роли могут быть двух типов:
* **обязательные** — роль не может выполняться без задания значений этих переменных при вызове роли
* **необязательные** — роль выполняется со значениями по-умолчанию, если эти переменные не заданы при вызове роли

Примеры:

* `meta/main.yml` (у роли с тремя обязательными и двумя необязательными аргументами):
  ```yaml
  ---
  ```

* `defaults/main.yml` (у роли без аргументов):
  ```yaml
  ---
  ```

Таким образом, глядя в `meta/main.yml`, всегда видно **все** аргументы роли
(или их отсутствие, если роль не принимает никаких параметров).

#### d6. Роли. Приватные переменные

Приватные переменные роли — это переменные, которые определяются и используются исключительно
внутри роли. Значения этих переменных зависят только от внутренней логики самой роли.

Приватные переменные определяются в каталоге `vars`.

* `vars/main.yml`:
  ```yaml
  ---
  TODO: пример из intranet-docker, про ключи
  ```

#### d7. Роли. Область видимости переменных

Все переменные, определённые в роли, должны оставаться доступными только внутри роли.

Чтобы обеспечить это, необходимо добавить параметр `private_role_vars` в конфигурацию Ansible:

* `ansible.cfg`:
  ```ini
  [defaults]
  private_role_vars = true
  ```

Пример того, какой эффект оказывает этот параметр при использовании ролей:

* `roles/test/defaults/main.yml`:
  ```yaml
  ---
  _required_vars:
    - service_name

  service_port: 8000
  ```

* `roles/test/tasks/main.yml`:
  ```yaml
  ---
  - name: Install '{{ service_name }}'
    debug:
      var: service_port
  ```

* плейбук:
  ```yaml
  - hosts: 127.0.0.1
    connection: local
    gather_facts: false
    roles:
      - role: test
        vars:
          service_name: service_one
          service_port: 9999

      - role: test
        vars:
          service_name: service_two
          # ожидается, что service_port при выполнении этой роли примет значнение по-умолчанию (8000)
  ```

* Выполнение плейбука при `private_role_vars = false` (значение по-умолчанию):
  ```
  PLAY [127.0.0.1] *********************************************************************************

  TASK [test : Install 'service_one'] **************************************************************
  ok: [127.0.0.1] => {
      "service_port": 9999
  }

  TASK [test : Install 'service_two'] **************************************************************
  ok: [127.0.0.1] => {
      "service_port": 9999
  }
  ```

* Выполнение плейбука при `private_role_vars = true` (как должно быть):
  ```
  PLAY [127.0.0.1] *********************************************************************************

  TASK [test : Install 'service_one'] **************************************************************
  ok: [127.0.0.1] => {
      "service_port": 9999
  }

  TASK [test : Install 'service_two'] **************************************************************
  ok: [127.0.0.1] => {
      "service_port": 8000
  }
  ```

## Приложение. Инструментарий (TODO)

* `ansible.cfg`
* `editorconfig`
* `.gitattributes`
* `cookiecutter`
* `yamlint`
* `ansiblelint`
